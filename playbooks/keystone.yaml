---
- hosts: controller
  sudo: True
  vars:
    admin_token: 012345SECRET99TOKEN012345
  tasks:


  # http://docs.openstack.org/folsom/openstack-compute/install/apt/content/install-keystone.html
  - name: ensure keystone package is installed
    apt: pkg=keystone

  - name: ensure sqlite keystone database is deleted
    file: dest=/var/lib/keystone/keystone.db state=absent

  - name: ensure keystone database is present
    mysql_db: name=keystone

  - name: ensure keystone database user is present
    mysql_user: name=keystone host=% password=${keystone_db_password} priv=keystone.*:ALL

  - name: ensure keystone config script is present
    template: src=templates/etc/keystone/keystone.conf dest=/etc/keystone/keystone.conf owner=keystone group=keystone mode=0600
    notify: restart keystone

  - name: initialize keystone database
    keystone_manage: action=db_sync
    notify: restart keystone

    # http://docs.openstack.org/folsom/openstack-compute/install/apt/content/setting-up-tenants-users-and-roles-manually.html
    # Same as keystone tenant-craete
  - name: create default tenant
    keystone_user: token=$admin_token tenant=demo tenant_description="Default Tenant"
    tags: keystone

    # Same as keystone user-create
  - name: create admin user
    keystone_user: token=$admin_token user=admin tenant=demo password=secrete
    tags: keystone

    # Same as keystone role-create and keystone user-role-add
  - name: create admin role and associate it with admin user
    keystone_user: token=$admin_token role=admin user=admin tenant=demo
    tags: keystone

  handlers:
   - name: restart keystone
     service: name=keystone state=restarted
