---
- hosts: controller
  sudo: True
  vars:
    admin_token: 012345SECRET99TOKEN012345
  tasks:


  # http://docs.openstack.org/folsom/openstack-compute/install/apt/content/install-keystone.html
  - name: ensure keystone package is installed
    apt: pkg=keystone

  - name: ensure sqlite keystone database is deleted
    file: dest=/var/lib/keystone/keystone.db state=absent

  - name: ensure keystone database is present
    mysql_db: name=keystone

  - name: ensure keystone database user is present
    mysql_user: name=keystone host=% password=${keystone_db_password} priv=keystone.*:ALL

  - name: ensure keystone config script is present
    template: src=templates/etc/keystone/keystone.conf dest=/etc/keystone/keystone.conf owner=keystone group=keystone mode=0600
    notify: restart keystone

  - name: initialize keystone database
    keystone_manage: action=db_sync
    notify: restart keystone

  - name: create default tenant
    keystone_user: token=$admin_token tenant=demo tenant_description="Default Tenant"
    tags: keystone

  # http://docs.openstack.org/folsom/openstack-compute/install/apt/content/setting-up-tenants-users-and-roles-manually.html


#### http://docs.openstack.org/folsom/openstack-compute/install/apt/content/setting-up-tenants-users-and-roles-manually.html
###  - name: ensure keystone-init.py is present
###    action: copy src=files/keystone-init.py dest=/tmp/keystone-init.py owner=root group=root mode=0755
###  - name: ensure kestyone-config.yaml is present
###    action: template src=templates/keystone-config.yaml dest=/tmp/keystone-config.yaml owner=root group=root mode=0600

  handlers:
   - name: restart keystone
     service: name=keystone state=restarted
