---
- name: attempt to load vboxguest module
  command: /sbin/modprobe vboxguest
  register: modprobe_result
  ignore_errors: True

- name: make sure packages needed to rebuild virtualbox modules are installed
  apt: pkg="{{ item }}" state=latest
  with_items:
    - build-essential
    - dkms
  when: modprobe_result|failed

- name: build virtualbox modules
  command: /etc/init.d/vboxadd setup
  when: modprobe_result|failed

- name: vagrant needs to be stopped and restarted to remount shared directory
  sudo: False
  delegate_to: localhost
  shell: cd {{ inventory_dir }}/vms; vagrant halt {{ inventory_hostname }}
  ignore_errors: True

# FIXME: do-until loops not working yet, so just try 3 times...

- name: vagrant up
  sudo: False
  delegate_to: localhost
  register: vagrantup_result
  ignore_errors: True
  shell: cd {{ inventory_dir }}/vms; vagrant up {{ inventory_hostname }}
  
- name: vagrant up
  sudo: False
  delegate_to: localhost
  register: vagrantup_result
  ignore_errors: True
  shell: cd {{ inventory_dir }}/vms; vagrant up {{ inventory_hostname }}
  when: vagrantup_result|failed

- name: vagrant up
  sudo: False
  delegate_to: localhost
  register: vagrantup_result
  shell: cd {{ inventory_dir }}/vms; vagrant up {{ inventory_hostname }}
  when: vagrantup_result|failed
