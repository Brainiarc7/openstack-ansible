---
- name: attempt to load vboxguest module
  command: /sbin/modprobe vboxguest
  register: modprobe_result
  ignore_errors: True

- name: make sure packages needed to rebuild virtualbox modules are installed
  apt: pkg="{{ item }}" state=latest update_cache=yes cache_valid_time=600
  with_items:
    - build-essential
    - dkms
  when: modprobe_result|failed

- name: build virtualbox modules
  command: /etc/init.d/vboxadd setup
  when: modprobe_result|failed

- name: vagrant needs to be stopped and restarted to remount shared directory
  sudo: False
  delegate_to: localhost
  shell: cd {{ inventory_dir }}/vms; flock -x .lock -c "vagrant halt {{ inventory_hostname }}"
  ignore_errors: True
  when: modprobe_result|failed

- name: vagrant up
  sudo: False
  delegate_to: localhost
  register: vagrantup_result
  shell: cd {{ inventory_dir }}/vms; flock -x .lock -c "vagrant up {{ inventory_hostname }}"
  when: modprobe_result|failed
